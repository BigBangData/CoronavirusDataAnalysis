---
title: "Coronavirus Data Analysis"
author: "Marcelo Sanches"
date: "3/27/2020"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r include=FALSE}
# setup
rm(list = ls())
options(scipen=999)

install_packages <- function(package){
  
  newpackage <- package[!(package %in% installed.packages()[, "Package"])]
      
	if (length(newpackage)) {
      suppressMessages(install.packages(newpackage, dependencies = TRUE))
	}
	sapply(package, require, character.only = TRUE)
}


# install packages  
packages <- c("dygraphs", "tidyverse", "xts", "RColorBrewer")
suppressPackageStartupMessages(install_packages(packages))
```


```{r include=FALSE}

# preprocessing function
preprocess <- function() {

	# create a folder for the data 
	dir_name <- "COVID19_DATA"
	if (!file.exists(dir_name)) {
		dir.create(dir_name)
	}
	
	dir_path <- "COVID19_DATA/"
	
	# download today's file, save as RDS first time, read otherwise
	file_name <- paste0(dir_path, gsub("-", "", Sys.Date()), "_data.rds")
	
	if (!file.exists(file_name)) {

		# create URLs
		http_header <- "https://data.humdata.org/hxlproxy/data/download/time_series_covid19_"
		
		url_body <- paste0("_narrow.csv?dest=data_edit&filter01=explode&explode-header-att01="
		                  ,"date&explode-value-att01=value&filter02=rename&rename-oldtag02=%23"
		                  ,"affected%2Bdate&rename-newtag02=%23date&rename-header02=Date&filter"
		                  ,"03=rename&rename-oldtag03=%23affected%2Bvalue&rename-newtag03=%23af"
		                  ,"fected%2Binfected%2Bvalue%2Bnum&rename-header03=Value&filter04=clea"
		                  ,"n&clean-date-tags04=%23date&filter05=sort&sort-tags05=%23date&sort-"
		                  ,"reverse05=on&filter06=sort&sort-tags06=%23country%2Bname%2C%23adm1%"
		                  ,"2Bname&tagger-match-all=on&tagger-default-tag=%23affected%2Blabel&t"
		                  ,"agger-01-header=province%2Fstate&tagger-01-tag=%23adm1%2Bname&tagger"
		                  ,"-02-header=country%2Fregion&tagger-02-tag=%23country%2Bname&tagger-"
		                  ,"03-header=lat&tagger-03-tag=%23geo%2Blat&tagger-04-header=long&tagge"
		                  ,"r-04-tag=%23geo%2Blon&header-row=1&url=https%3A%2F%2Fraw.githubuserc"
		                  ,"ontent.com%2FCSSEGISandData%2FCOVID-19%2Fmaster%2Fcsse_covid_19_data"
		                  ,"%2Fcsse_covid_19_time_series%2Ftime_series_covid19_")
		
		
		confirmed_URL  <- paste0(http_header, "confirmed_global", url_body, "confirmed_global.csv")
		fatal_URL <- paste0(http_header, "deaths_global", url_body, "deaths_global.csv")
		recovered_URL  <- paste0(http_header, "recovered_global", url_body, "recovered_global.csv")
									
		# download
		download.file(confirmed_URL, destfile=paste0(dir_path, "confirmed.csv"))
		download.file(fatal_URL, destfile=paste0(dir_path, "fatal.csv"))
		download.file(recovered_URL, destfile=paste0(dir_path, "recovered.csv"))
		
		# load csvs
		load_csv <- function(filename) { 
			filename <- read.csv(paste0(dir_path, filename, ".csv"), header=TRUE
			                     , fileEncoding="UTF-8-BOM"
								           , stringsAsFactors=FALSE, na.strings="")[-1, ]
			filename
		}
	
		confirmed  <- load_csv("confirmed")
		fatal <- load_csv("fatal") 
		recovered  <- load_csv("recovered")
		
		# prep data for long format
		
		# add column identifying the dataset	
		add_col <- function(dfm, name) {
			dfm$Status <- rep(name, nrow(dfm))
			dfm
		}
		
		confirmed  <- add_col(confirmed, "confirmed")
		fatal <- add_col(fatal, "fatal")
		recovered  <- add_col(recovered, "recovered")
		
		# join (union actually) into one dataset 
		dfm <- rbind(confirmed, fatal, recovered, make.row.names=FALSE)
		
		# rename columns 
		colnames(dfm) <- c("Province_State", "Country_Region"
				  , "Lat", "Long", "Date", "Value", "Status")
		
		# fix data types 
		dfm$Value <- as.integer(dfm$Value)
		dfm$Lat <- as.numeric(dfm$Lat)
		dfm$Long <- as.numeric(dfm$Long)
		dfm$Date <- as.Date(dfm$Date)
		dfm$Status <- as.factor(dfm$Status)
	
		# save as RDS 
		saveRDS(dfm, file = file_name)
		
	} 

	dfm <- readRDS(file_name) 

}

```



This is a simple exploration of the time series data which was compiled by the Johns Hopkins University Center for Systems Science and Engineering (JHU CCSE) from various sources (see website for full description). The data can be downloaded manually at [Novel Coronavirus 2019 Cases.](https://data.humdata.org/dataset/novel-coronavirus-2019-ncov-cases)


## Contents {#contents-link}

* [Data Pre-Processing](#preprocess-link)
* [Data Cleanup](#cleanup-link)
* [Exploratory Data Analysis](#eda-link)
* [Code Appendix](#codeappendix-link)

---

## Data Pre-Processing {#preprocess-link}

The `preprocess` function creates a local folder and pulls three csv files, one for each stage in tracking the coronavirus spread (confirmed, fatal, and recovered cases), performs various pre-processing steps to create one narrow and long dataset, saving it in compressed RDS format. See code in the [Code Appendix.](#codeappendix-link)



```{r}
# read in RDS file 
dfm <- preprocess()
str(dfm)
```


There are `r nrow(dfm)` rows and `r length(dfm)` columns. There's a 'Status' column for the different stages, so the number of rows is 3 times the number of rows for a single status (ex. "confirmed"). Each single-status dataset is as long as the number of days in the time series (for a given day the data is pulled) times the number of countries and sub-national provinces or states. This number varies per country, and also varies per day depending on how the dataset is built. 


---

[Back to [Contents](#contents-link)]{style="float:right"}

## Data Cleanup  {#cleanup-link}


### Location Granularity 

The data's location variables have several issues. The `Country_Region` variable represents a larger area while the `Province_State` represents more granular areas. There are a few countries which include the subnational provinces or states, and others that do not. In the US, the granularity sometimes arrives at county level (Mar 27 UPDATE: this has not been true in recent days.)

All these differences represent a problem when grouping by a certain area. This can be visualized in [Johns Hopkins' dashboard](https://coronavirus.jhu.edu/map.html): the totals for fatalities are grouped by a mixture of countries and sub-national geographic areas. The US is conspicuously missing. I will delve into subnational data at another time, so I recreated the dataset at the national level (see [Code Appendix](#codeappendix-link) for details).
 


```{r include=FALSE}
# recreating dataset at national level
national <- unique(dfm$Country_Region[is.na(dfm$Province_State)])
subnational <- unique(dfm$Country_Region[!is.na(dfm$Province_State)])

nat_df <- dfm[dfm$Country_Region %in% national, ]
sub_df <- dfm[dfm$Country_Region %in% subnational, ]

nat_df <- as.data.frame(nat_df %>%
						select(Country_Region, Status, Date, Value))

# aggregate countries with subnational data to national level
sub_df <- as.data.frame(sub_df %>%
					    select(Country_Region, Status, Date, Value) %>%
					    group_by(Country_Region, Status, Date) %>% 
					    summarise('Value'=sum(Value)))
						
dfm <- rbind(nat_df, sub_df) 

dfm <- as.data.frame(dfm %>% 
					arrange(Country_Region, Status, desc(Date)))
```



---

[Back to [Contents](#contents-link)]{style="float:right"}


## Exploratory Data Analysis {#eda-link}



``` {r include=FALSE} 
# subset to current counts 
current <- data.frame(dfm %>%
						filter(Date == unique(dfm$Date)[1])) %>%
            arrange(Status, desc(Value))

# subset to world totals 
totals <- data.frame(current %>% 
						group_by(Status) %>%
						summarise('total'=sum(Value)))
```



| `r colnames(totals)[1]` | `r colnames(totals)[2]` |
|:--------------------:|:-------------------:|
| `r totals$Status[1]` | `r totals$total[1]` |
| `r totals$Status[2]` | `r totals$total[2]` |
| `r totals$Status[3]` | `r totals$total[3]` |
|                     |                    |
  
Table: Current Grand Totals


### Time Series Plots per Status and Location

This interactive time series speaks for itself: the US has overtaken Italy and China in number of confirmed cases in the last two days.



```{r fig.height=5, fig.width=9, echo=FALSE}
# function to create an xts series given dataframe, country, and status
create_xts_series <- function(dfm, country, status) {
	dfm <- dfm[dfm$Country_Region == country & dfm$Status == status, ]
	series <- xts(dfm$Value, order.by = dfm$Date)
	series
}

# Confirmed
US <- create_xts_series(dfm, "US", "confirmed")
Italy <- create_xts_series(dfm, "Italy", "confirmed")
China <- create_xts_series(dfm, "China", "confirmed")
Spain <- create_xts_series(dfm, "Spain", "confirmed")
Germany <- create_xts_series(dfm, "Germany", "confirmed")

seriesObject <- cbind(US, Italy, China, Spain, Germany)
				 
dfm_interactive <- dygraph(seriesObject
						   ,main="US Overtakes Italy and China in Confirmed Cases"
						   ,xlab=""
						   ,ylab="Number of Confirmed Cases") %>% 
						   dyOptions(colors = brewer.pal(5,"Dark2")) %>%						  
						   dyRangeSelector()


dfm_interactive
```


This is the same visualization using the data on fatalities:

```{r fig.height=5, fig.width=9, echo=FALSE}
# Fatalities
US <- create_xts_series(dfm, "US", "fatal")
Italy <- create_xts_series(dfm, "Italy", "fatal")
China <- create_xts_series(dfm, "China", "fatal")
Spain <- create_xts_series(dfm, "Spain", "fatal")
Germany <- create_xts_series(dfm, "Germany", "fatal")

seriesObject <- cbind(US, Italy, China, Spain, Germany)
				 
dfm_interactive <- dygraph(seriesObject
						   ,main="Italy Leads in Fatalities"
						   ,xlab=""
						   ,ylab="Number of Fatalities") %>% 
						   dyOptions(colors = brewer.pal(5,"Dark2")) %>%						  
						   dyRangeSelector()

dfm_interactive
```


This is the same visualization using the data on recoveries:

```{r fig.height=5, fig.width=9, echo=FALSE}
# Recovered
US <- create_xts_series(dfm, "US", "recovered")
Italy <- create_xts_series(dfm, "Italy", "recovered")
China <- create_xts_series(dfm, "China", "recovered")
Spain <- create_xts_series(dfm, "Spain", "recovered")
Germany <- create_xts_series(dfm, "Germany", "recovered")

seriesObject <- cbind(US, Italy, China, Spain, Germany)
				 
dfm_interactive <- dygraph(seriesObject
						   ,main="China Leads in Recoveries"
						   ,xlab=""
						   ,ylab="Number of Recoveries") %>% 
						   dyOptions(colors = brewer.pal(5,"Dark2")) %>%						  
						   dyRangeSelector()

dfm_interactive
```

Since China dominates this plot too much, it would be interesting to see how the other countries are doing as far as recoveries:

```{r fig.height=5, fig.width=9, echo=FALSE}
# Recovered - other four countries
seriesObject <- cbind(US, Italy, Spain, Germany)
				 
dfm_interactive <- dygraph(seriesObject
						   ,main="After China, Italy Leads in Recoveries"
						   ,xlab=""
						   ,ylab="Number of Recoveries") %>% 
						   dyOptions(colors = brewer.pal(4,"Dark2")) %>%						  
						   dyRangeSelector()

dfm_interactive
```



---

[Back to [Contents](#contents-link)]{style="float:right"}

### Code Appendix {#codeappendix-link}

```{r eval=FALSE}


## Setup

rm(list = ls())
options(scipen=999)

install_packages <- function(package){
  
  newpackage <- package[!(package %in% installed.packages()[, "Package"])]
      
	if (length(newpackage)) {
      suppressMessages(install.packages(newpackage, dependencies = TRUE))
	}
	sapply(package, require, character.only = TRUE)
}


# install packages  
packages <- c("dygraphs", "tidyverse", "xts", "RColorBrewer")
suppressPackageStartupMessages(install_packages(packages))


## Data Pre-Processing


# preprocessing function
preprocess <- function() {

	# create a folder for the data 
	dir_name <- "COVID19_DATA"
	if (!file.exists(dir_name)) {
		dir.create(dir_name)
	}
	
	dir_path <- "COVID19_DATA/"
	
	# download today's file, save as RDS first time, read otherwise
	file_name <- paste0(dir_path, gsub("-", "", Sys.Date()), "_data.rds")
	
	if (!file.exists(file_name)) {

		# create URLs
		http_header <- "https://data.humdata.org/hxlproxy/data/download/time_series_covid19_"
		
		url_body <- paste0("_narrow.csv?dest=data_edit&filter01=explode&explode-header-att01="
		                  ,"date&explode-value-att01=value&filter02=rename&rename-oldtag02=%23"
		                  ,"affected%2Bdate&rename-newtag02=%23date&rename-header02=Date&filter"
		                  ,"03=rename&rename-oldtag03=%23affected%2Bvalue&rename-newtag03=%23af"
		                  ,"fected%2Binfected%2Bvalue%2Bnum&rename-header03=Value&filter04=clea"
		                  ,"n&clean-date-tags04=%23date&filter05=sort&sort-tags05=%23date&sort-"
		                  ,"reverse05=on&filter06=sort&sort-tags06=%23country%2Bname%2C%23adm1%"
		                  ,"2Bname&tagger-match-all=on&tagger-default-tag=%23affected%2Blabel&t"
		                  ,"agger-01-header=province%2Fstate&tagger-01-tag=%23adm1%2Bname&tagger"
		                  ,"-02-header=country%2Fregion&tagger-02-tag=%23country%2Bname&tagger-"
		                  ,"03-header=lat&tagger-03-tag=%23geo%2Blat&tagger-04-header=long&tagge"
		                  ,"r-04-tag=%23geo%2Blon&header-row=1&url=https%3A%2F%2Fraw.githubuserc"
		                  ,"ontent.com%2FCSSEGISandData%2FCOVID-19%2Fmaster%2Fcsse_covid_19_data"
		                  ,"%2Fcsse_covid_19_time_series%2Ftime_series_covid19_")

		
		
		confirmed_URL  <- paste0(http_header, "confirmed_global", url_body, "confirmed_global.csv")
		fatal_URL <- paste0(http_header, "deaths_global", url_body, "deaths_global.csv")
		recovered_URL  <- paste0(http_header, "recovered_global", url_body, "recovered_global.csv")
									
		# download
		download.file(confirmed_URL, destfile=paste0(dir_path, "confirmed.csv"))
		download.file(fatal_URL, destfile=paste0(dir_path, "fatal.csv"))
		download.file(recovered_URL, destfile=paste0(dir_path, "recovered.csv"))
		
		# load csvs
		load_csv <- function(filename) { 
		
			filename <- read.csv(paste0(dir_path, filename, ".csv")
								 , header=TRUE
								 , fileEncoding="UTF-8-BOM"
								 , stringsAsFactors=FALSE, na.strings="")[-1, ]
			filename
		}
	
		confirmed  <- load_csv("confirmed")
		fatal <- load_csv("fatal") 
		recovered  <- load_csv("recovered")
		
		# prep data for long format
		
		# add column identifying the dataset	
		add_col <- function(dfm, name) {
			dfm$Status <- rep(name, nrow(dfm))
			dfm
		}
		
		confirmed  <- add_col(confirmed, "confirmed")
		fatal <- add_col(fatal, "fatal")
		recovered  <- add_col(recovered, "recovered")
		
		# join (union actually) into one dataset 
		dfm <- rbind(confirmed, fatal, recovered, make.row.names=FALSE)
		
		# rename columns 
		colnames(dfm) <- c("Province_State", "Country_Region"
				      , "Lat", "Long", "Date", "Value", "Status")
		
		# fix data types 
		dfm$Value <- as.integer(dfm$Value)
		dfm$Lat <- as.numeric(dfm$Lat)
		dfm$Long <- as.numeric(dfm$Long)
		dfm$Date <- as.Date(dfm$Date)
		dfm$Status <- as.factor(dfm$Status)
	
		# save as RDS 
		saveRDS(dfm, file = file_name)
		
	} 

	dfm <- readRDS(file_name) 

}


# read in RDS file 
dfm <- preprocess()

str(dfm)


## Data Cleanup

### Location Granularity

# recreating dataset at national level
national <- unique(dfm$Country_Region[is.na(dfm$Province_State)])
subnational <- unique(dfm$Country_Region[!is.na(dfm$Province_State)])

nat_df <- dfm[dfm$Country_Region %in% national, ]
sub_df <- dfm[dfm$Country_Region %in% subnational, ]

nat_df <- as.data.frame(nat_df %>%
						select(Country_Region, Status, Date, Value))

# aggregate countries with subnational data to national level
sub_df <- as.data.frame(sub_df %>%
					    select(Country_Region, Status, Date, Value) %>%
					    group_by(Country_Region, Status, Date) %>% 
					    summarise('Value'=sum(Value)))
						
dfm <- rbind(nat_df, sub_df) 

dfm <- as.data.frame(dfm %>% 
					arrange(Country_Region, Status, desc(Date)))



## Exploratory Data Analysis {#eda-link}

# subset to current counts 
current <- data.frame(dfm %>%
					  filter(Date == unique(dfm$Date)[1])) %>%
					  arrange(Status, desc(Value))

# subset to world totals 
totals <- data.frame(current %>% 
					 group_by(Status) %>%
					 summarise('total'=sum(Value)))


#' | `r colnames(totals)[1]` | `r colnames(totals)[2]` |
#' |:--------------------:|:-------------------:|
#' | `r totals$Status[1]` | `r totals$total[1]` |
#' | `r totals$Status[2]` | `r totals$total[2]` |
#' | `r totals$Status[3]` | `r totals$total[3]` |
#' |                     |                    |
#'   
#' Table: Current Grand Totals


### Time Series Plots per Status and Location

# function to create an xts series given dataframe, country, and status
create_xts_series <- function(dfm, country, status) {
  
	dfm <- dfm[dfm$Country_Region == country & dfm$Status == status, ]
	series <- xts(dfm$Value, order.by = dfm$Date)
	series
}

# Confirmed 
US <- create_xts_series(dfm, "US", "confirmed")
Italy <- create_xts_series(dfm, "Italy", "confirmed")
China <- create_xts_series(dfm, "China", "confirmed")
Spain <- create_xts_series(dfm, "Spain", "confirmed")
Germany <- create_xts_series(dfm, "Germany", "confirmed")

seriesObject <- cbind(US, Italy, China, Spain, Germany)
				 
dfm_interactive <- dygraph(seriesObject
						   ,main="US Overtakes Italy and China in Confirmed Cases"
						   ,xlab=""
						   ,ylab="Number of Confirmed Cases") %>% 
						   dyOptions(colors = brewer.pal(5,"Dark2")) %>%						  
						   dyRangeSelector()


dfm_interactive

# Fatalities
US <- create_xts_series(dfm, "US", "fatal")
Italy <- create_xts_series(dfm, "Italy", "fatal")
China <- create_xts_series(dfm, "China", "fatal")
Spain <- create_xts_series(dfm, "Spain", "fatal")
Germany <- create_xts_series(dfm, "Germany", "fatal")

seriesObject <- cbind(US, Italy, China, Spain, Germany)
				 
dfm_interactive <- dygraph(seriesObject
						   ,main="Italy Leads in Fatalities"
						   ,xlab=""
						   ,ylab="Number of Fatalities") %>% 
						   dyOptions(colors = brewer.pal(5,"Dark2")) %>%						  
						   dyRangeSelector()

dfm_interactive

# Recovered
US <- create_xts_series(dfm, "US", "recovered")
Italy <- create_xts_series(dfm, "Italy", "recovered")
China <- create_xts_series(dfm, "China", "recovered")
Spain <- create_xts_series(dfm, "Spain", "recovered")
Germany <- create_xts_series(dfm, "Germany", "recovered")

seriesObject <- cbind(US, Italy, China, Spain, Germany)
				 
dfm_interactive <- dygraph(seriesObject
						   ,main="China Leads in Recoveries"
						   ,xlab=""
						   ,ylab="Number of Recoveries") %>% 
						   dyOptions(colors = brewer.pal(5,"Dark2")) %>%						  
						   dyRangeSelector()

dfm_interactive

# Recovered - other four countries
seriesObject <- cbind(US, Italy, Spain, Germany)
				 
dfm_interactive <- dygraph(seriesObject
						   ,main="Italy Leads in Recoveries"
						   ,xlab=""
						   ,ylab="Number of Recoveries") %>% 
						   dyOptions(colors = brewer.pal(4,"Dark2")) %>%						  
						   dyRangeSelector()

dfm_interactive
```



```{r}
# uncomment to run, creates Rcode file with R code, set documentation = 1 to avoid text commentary
#library(knitr)
#options(knitr.purl.inline = TRUE)
#purl("COVID19_DATA_ANALYSIS.Rmd", output = "Rcode.R", documentation = 2)
``` 



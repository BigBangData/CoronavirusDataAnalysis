```{r}
# environment setup 
rm(list = ls())
options(scipen=999)

# install and load packages  
install_packages <- function(package){
  
  newpackage <- package[!(package %in% installed.packages()[, "Package"])]
      
    if (length(newpackage)) {
      suppressMessages(install.packages(newpackage, dependencies = TRUE))
    }
    sapply(package, require, character.only = TRUE)
}

packages <- c("tidyverse", "sqldf")
suppressPackageStartupMessages(install_packages(packages))

# check if today's RDS file exists
rds_file <- paste0("data/", gsub("-", "", Sys.Date()), "_data.rds")

if (!file.exists(rds_file)) {
    print("Run CoronavirusDataAnalysis.Rmd first!")
} else {
    dfm <- readRDS(rds_file)
}

# remove seasonal "countries" like Antarctica and Olympics
dfm <- dfm[!dfm$Country %in% c('Antarctica', 'Summer Olympics 2020', 'Winter Olympics 2022'), ]

# read in static data set of countries and populations
country_population <- read.csv("data/country_population.csv")

# merge data sets
mm <- merge(dfm, country_population, by="Country")

# calculate percentages
mm$Percentage <- round(mm$Count/(mm$Population*1000)*100, 3)

# reorder by Country, Status, and Date descending
mm <- data.frame(mm %>% arrange(Country, Status, desc(Date)))

# calculate new cases
mm <- sqldf('
    SELECT 
        sq.*
        , LEAD(sq.CountLag - Count, 1) OVER (PARTITION BY Country, Status) AS NewCases
    FROM (
        SELECT 
            p.*
            , LAG(Count, 1) OVER (PARTITION BY Country, Status) AS CountLag
        FROM mm AS p
        ) AS sq
')

# remove temp col, replace NA, convert to int
mm$CountLag <- NULL
mm$NewCases[is.na(mm$NewCases)] <- 0
mm$NewCases <- as.integer(mm$NewCases)

# subset to last day, ordered by status and count desc
current_data <- data.frame(mm %>%
    filter(Date == unique(mm$Date)[1])) %>%
    arrange(Status, desc(Count))

current_data$Color <- ifelse(current_data$Status == "Confirmed", "#D6604D", "#202226")

# reorder & reshape
current_data <- current_data[, c("Date", "Country", "Status", "Color", "Count", "Percentage", "NewCases")]
colnames(current_data) <- c("Date", "Country", "Status", "Color", "Cumulative Count", "% Of Population", "New Cases")

current_data <- as.data.frame(
    current_data %>% pivot_longer(
        cols = c("Cumulative Count", "% Of Population", "New Cases")
            , names_to = "Type"
            , values_to = "Value"
    )
)

write.csv(current_data, "./CoronavirusShinyApp/current_data.csv", row.names = FALSE)
```





























